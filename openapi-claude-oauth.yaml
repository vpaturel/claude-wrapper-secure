openapi: 3.1.0
info:
  title: Claude OAuth API (Unofficial)
  version: 1.0.0
  description: |
    Reverse-engineered specification of Claude API via OAuth authentication.

    **⚠️ IMPORTANT**: OAuth tokens are restricted to Claude Code application only.
    Direct API calls will fail with 400 "Only authorized for Claude Code".

    **Solution**: Use the claude_oauth_api.py wrapper (included in project).

    Based on: 14 hours of reverse engineering, 62 captures, 176 SSE events.
    Confidence: ~78% average (90%+ captured, 70-75% extrapolated).

  contact:
    name: tincenv
    url: https://github.com/tincenv/analyse-claude-ai
  license:
    name: Educational Use Only

servers:
  - url: https://api.anthropic.com/v1
    description: Claude API Production

tags:
  - name: messages
    description: Message creation and streaming
  - name: oauth
    description: OAuth authentication (extrapolated)

paths:
  /messages:
    post:
      summary: Create a message
      description: |
        Send a message to Claude and get a response.
        Supports both streaming (SSE) and non-streaming modes.

        **OAuth Restriction**: Only works with Claude Code binary, not custom clients.
      tags:
        - messages
      security:
        - BearerAuth: []
      parameters:
        - name: anthropic-version
          in: header
          required: true
          schema:
            type: string
            example: "2023-06-01"
        - name: anthropic-beta
          in: header
          required: false
          description: Beta features flags (comma-separated)
          schema:
            type: string
            example: "oauth-2025-04-20,interleaved-thinking-2025-05-14"
        - name: x-app
          in: header
          required: false
          schema:
            type: string
            example: "cli"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
            examples:
              simple_message:
                summary: Simple text message
                value:
                  model: "claude-sonnet-4-5-20250929"
                  max_tokens: 1024
                  messages:
                    - role: "user"
                      content: "What is 2+2?"

              with_thinking:
                summary: Extended thinking mode
                value:
                  model: "claude-opus-4-20250514"
                  max_tokens: 4096
                  messages:
                    - role: "user"
                      content: "Explain quantum entanglement"
                  thinking:
                    type: "enabled"
                    budget_tokens: 30000

      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              examples:
                text_response:
                  summary: Simple text response
                  value:
                    id: "msg_01AbC123"
                    type: "message"
                    role: "assistant"
                    content:
                      - type: "text"
                        text: "4"
                    model: "claude-sonnet-4-5-20250929"
                    stop_reason: "end_turn"
                    usage:
                      input_tokens: 12
                      output_tokens: 5

            text/event-stream:
              schema:
                $ref: '#/components/schemas/StreamEvent'
              examples:
                thinking_stream:
                  summary: Stream with thinking
                  value: |
                    event: message_start
                    data: {"type":"message_start","message":{"id":"msg_01","type":"message","role":"assistant"}}

                    event: content_block_start
                    data: {"type":"content_block_start","index":0,"content_block":{"type":"thinking"}}

                    event: content_block_delta
                    data: {"type":"content_block_delta","index":0,"delta":{"type":"thinking_delta","thinking":"The user is asking..."}}

                    event: content_block_stop
                    data: {"type":"content_block_stop","index":0}

                    event: content_block_start
                    data: {"type":"content_block_start","index":1,"content_block":{"type":"text"}}

                    event: content_block_delta
                    data: {"type":"content_block_delta","index":1,"delta":{"type":"text_delta","text":"The answer is..."}}

                    event: message_stop
                    data: {"type":"message_stop"}

        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                oauth_restricted:
                  summary: OAuth credential restricted
                  value:
                    type: "error"
                    error:
                      type: "invalid_request_error"
                      message: "This credential is only authorized for use with Claude Code"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                oauth_not_supported:
                  summary: OAuth not supported for direct API
                  value:
                    type: "error"
                    error:
                      type: "authentication_error"
                      message: "OAuth authentication is currently not supported."

        '429':
          description: Rate Limit Exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                rate_limit:
                  summary: Too many requests
                  value:
                    type: "error"
                    error:
                      type: "rate_limit_error"
                      message: "Rate limit exceeded. Please try again later."

        '529':
          description: Service Overloaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                overloaded:
                  summary: Service temporarily unavailable
                  value:
                    type: "error"
                    error:
                      type: "overloaded_error"
                      message: "Service is temporarily overloaded. Please retry."

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: OAuth2
      description: |
        OAuth 2.0 access token in format: sk-ant-oat01-[TOKEN]

        **CRITICAL**: Tokens only work with Claude Code binary.
        For direct API access, use API Key (sk-ant-api03-*) instead.

  schemas:
    MessageRequest:
      type: object
      required:
        - model
        - max_tokens
        - messages
      properties:
        model:
          type: string
          enum:
            - claude-opus-4-20250514
            - claude-sonnet-4-5-20250929
            - claude-3-5-haiku-20241022
            - opus
            - sonnet
            - haiku
          description: Model to use (full name or alias)

        max_tokens:
          type: integer
          minimum: 1
          maximum: 16384
          description: Maximum tokens to generate (Opus/Sonnet 16K, Haiku 8K)

        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Conversation history

        system:
          type: string
          description: System prompt

        temperature:
          type: number
          minimum: 0
          maximum: 1
          default: 1.0
          description: Sampling temperature (not supported via CLI)

        stream:
          type: boolean
          default: false
          description: Enable Server-Sent Events streaming

        thinking:
          $ref: '#/components/schemas/ThinkingConfig'

    Message:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          oneOf:
            - type: string
            - type: array
              items:
                oneOf:
                  - $ref: '#/components/schemas/TextContent'
                  - $ref: '#/components/schemas/ImageContent'

    TextContent:
      type: object
      required:
        - type
        - text
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string

    ImageContent:
      type: object
      required:
        - type
        - source
      properties:
        type:
          type: string
          enum: [image]
        source:
          type: object
          required:
            - type
            - media_type
            - data
          properties:
            type:
              type: string
              enum: [base64]
            media_type:
              type: string
              enum: [image/jpeg, image/png, image/gif, image/webp]
            data:
              type: string
              format: byte
              description: Base64-encoded image data

    ThinkingConfig:
      type: object
      properties:
        type:
          type: string
          enum: [enabled, disabled]
          default: enabled
        budget_tokens:
          type: integer
          minimum: 1
          maximum: 30000
          description: Maximum thinking tokens (Opus/Sonnet only)

    MessageResponse:
      type: object
      properties:
        id:
          type: string
          example: "msg_01AbC123"
        type:
          type: string
          enum: [message]
        role:
          type: string
          enum: [assistant]
        content:
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/ThinkingBlock'
              - $ref: '#/components/schemas/TextBlock'
        model:
          type: string
        stop_reason:
          type: string
          enum: [end_turn, max_tokens, stop_sequence]
        usage:
          $ref: '#/components/schemas/Usage'

    ThinkingBlock:
      type: object
      properties:
        type:
          type: string
          enum: [thinking]
        thinking:
          type: string
          description: Model's internal reasoning process

    TextBlock:
      type: object
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string
          description: Generated text response

    Usage:
      type: object
      properties:
        input_tokens:
          type: integer
        output_tokens:
          type: integer

    StreamEvent:
      oneOf:
        - $ref: '#/components/schemas/MessageStartEvent'
        - $ref: '#/components/schemas/ContentBlockStartEvent'
        - $ref: '#/components/schemas/ContentBlockDeltaEvent'
        - $ref: '#/components/schemas/ContentBlockStopEvent'
        - $ref: '#/components/schemas/MessageDeltaEvent'
        - $ref: '#/components/schemas/MessageStopEvent'

    MessageStartEvent:
      type: object
      properties:
        type:
          type: string
          enum: [message_start]
        message:
          type: object
          properties:
            id:
              type: string
            type:
              type: string
            role:
              type: string

    ContentBlockStartEvent:
      type: object
      properties:
        type:
          type: string
          enum: [content_block_start]
        index:
          type: integer
        content_block:
          type: object
          properties:
            type:
              type: string
              enum: [thinking, text]

    ContentBlockDeltaEvent:
      type: object
      properties:
        type:
          type: string
          enum: [content_block_delta]
        index:
          type: integer
        delta:
          oneOf:
            - type: object
              properties:
                type:
                  type: string
                  enum: [thinking_delta]
                thinking:
                  type: string
            - type: object
              properties:
                type:
                  type: string
                  enum: [text_delta]
                text:
                  type: string

    ContentBlockStopEvent:
      type: object
      properties:
        type:
          type: string
          enum: [content_block_stop]
        index:
          type: integer

    MessageDeltaEvent:
      type: object
      properties:
        type:
          type: string
          enum: [message_delta]
        delta:
          type: object
          properties:
            stop_reason:
              type: string
        usage:
          $ref: '#/components/schemas/Usage'

    MessageStopEvent:
      type: object
      properties:
        type:
          type: string
          enum: [message_stop]

    Error:
      type: object
      properties:
        type:
          type: string
          enum: [error]
        error:
          type: object
          properties:
            type:
              type: string
              enum:
                - invalid_request_error
                - authentication_error
                - permission_error
                - not_found_error
                - rate_limit_error
                - api_error
                - overloaded_error
            message:
              type: string

x-rate-limits:
  description: |
    Estimated rate limits (90% based on Opus weekly quota capture):

    - **Opus**: ~100 messages/week (Max), ~50/week (Pro)
    - **Sonnet**: ~40,000 TPM, 50 RPM (estimated)
    - **Haiku**: ~50,000 TPM, 100 RPM (estimated)

    Rate limit headers (extrapolated, not captured):
    - x-ratelimit-requests-limit
    - x-ratelimit-requests-remaining
    - x-ratelimit-requests-reset
    - x-ratelimit-tokens-limit
    - x-ratelimit-tokens-remaining
    - x-ratelimit-tokens-reset

x-confidence-levels:
  oauth_architecture: 100%
  sse_streaming: 95%
  extended_thinking: 90%
  http_errors: 70%
  rate_limits: 70%
  overall: 78%
