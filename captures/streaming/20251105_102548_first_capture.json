[
  {
    "request": {
      "timestamp": "2025-11-05T10:25:48.517710",
      "method": "POST",
      "path": "/v1/messages?beta=true",
      "headers": {
        "accept": "application/json",
        "anthropic-beta": "oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14",
        "anthropic-dangerous-direct-browser-access": "true",
        "anthropic-version": "2023-06-01",
        "authorization": "Bearer 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",
        "content-type": "application/json",
        "user-agent": "claude-cli/2.0.33 (external, cli)",
        "x-app": "cli",
        "x-stainless-arch": "x64",
        "x-stainless-helper-method": "stream",
        "x-stainless-lang": "js",
        "x-stainless-os": "Linux",
        "x-stainless-package-version": "0.66.0",
        "x-stainless-retry-count": "0",
        "x-stainless-runtime": "node",
        "x-stainless-runtime-version": "v24.3.0",
        "x-stainless-timeout": "600",
        "Connection": "keep-alive",
        "Host": "localhost:8000",
        "Accept-Encoding": "gzip, deflate, br, zstd",
        "Content-Length": "29569"
      },
      "body": {
        "model": "claude-haiku-4-5-20251001",
        "messages": [
          {
            "role": "user",
            "content": [
              {
                "type": "text",
                "text": "<system-reminder>\nAs you answer the user's questions, you can use the following context:\n# claudeMd\nCodebase and user instructions are shown below. Be sure to adhere to these instructions. IMPORTANT: These instructions OVERRIDE any default behavior and you MUST follow them exactly as written.\n\nContents of /home/tincenv/.claude/CLAUDE.md (user's private global instructions for all projects):\n\n# \ud83e\udd16 Claude Code - Instructions tincenv ULTIME\n\n## \ud83d\ude80 EX\u00c9CUTION AUTOMATIQUE EN PARALL\u00c8LE\n\n**R\u00c8GLE ABSOLUE:** Utiliser Task tool pour TOUTES t\u00e2ches complexes afin de :\n- \u2705 R\u00e9duire tokens dans conversation principale\n- \u2705 Ex\u00e9cuter t\u00e2ches en parall\u00e8le (5-10x plus rapide)\n- \u2705 Meilleure autonomie\n\n### Quand utiliser Task tool (OBLIGATOIRE)\n\n**TOUJOURS utiliser pour:**\n- Cr\u00e9ation de fichiers multiples (>2 fichiers)\n- Recherche/exploration codebase\n- Code review complet\n- Tests automatis\u00e9s (linting, tests, s\u00e9curit\u00e9)\n- G\u00e9n\u00e9ration code depuis contrats\n- Refactoring >100 lignes\n- Documentation compl\u00e8te\n- Analyse multi-fichiers\n\n**Exemple CORRECT:**\n```\nUSER: Cr\u00e9e un endpoint POST /users avec tests\n\nCLAUDE: Je vais lancer 3 agents en parall\u00e8le:\n- Agent 1: Cr\u00e9er tests unitaires\n- Agent 2: Cr\u00e9er endpoint FastAPI\n- Agent 3: Cr\u00e9er tests contrat\n\n[Utilise Task tool 3 fois en parall\u00e8le]\n```\n\n**Exemple INCORRECT (\u274c):**\n```\nUSER: Cr\u00e9e un endpoint POST /users avec tests\n\nCLAUDE: [Cr\u00e9e directement les fichiers un par un dans conversation]\n\u274c Consomme trop de tokens\n\u274c Pas de parall\u00e9lisation\n\u274c Lent\n```\n\n### Format parall\u00e9lisation\n\n```markdown\n**Plan d'ex\u00e9cution parall\u00e8le:**\n1. \u2705 Agent A - Cr\u00e9er backend/src/api/routes.py\n2. \u2705 Agent B - Cr\u00e9er backend/tests/unit/test_routes.py\n3. \u2705 Agent C - Cr\u00e9er backend/tests/contract/test_api.py\n\n[Lance 3 Task tools simultan\u00e9ment]\n\n**R\u00e9sultats:**\n- Agent A: \u2705 Termin\u00e9 (route cr\u00e9\u00e9e)\n- Agent B: \u2705 Termin\u00e9 (tests unitaires OK)\n- Agent C: \u2705 Termin\u00e9 (tests contrat OK)\n```\n\n### Seuils d\u00e9clenchement\n\n| T\u00e2che | Utiliser Task | Raison |\n|-------|---------------|--------|\n| Cr\u00e9er 1 fichier simple | \u274c | Direct OK |\n| Cr\u00e9er 2+ fichiers | \u2705 | Parall\u00e9lisation |\n| Recherche codebase | \u2705 | \u00c9conomie tokens |\n| Tests complets | \u2705 | Autonomie |\n| Refactor >50 lignes | \u2705 | Complexit\u00e9 |\n\n---\n\n## \ud83e\udde0 MODE EXTENDED THINKING\n\n**TOUJOURS ACTIF:** Configuration via `MAX_THINKING_TOKENS=30000` dans ~/.bashrc\n**Mod\u00e8le:** `opus` pour qualit\u00e9 maximale (Plan Max)\n\n---\n\n## \ud83d\udea8 R\u00c8GLE #1 : TDD OBLIGATOIRE\n\n**PROCESSUS IMPOS\u00c9:**\n```\n1. Cr\u00e9er tests/unit/test_*.py (RED)\n2. Ex\u00e9cuter pytest (doit \u00e9chouer)\n3. Cr\u00e9er src/*.py\n4. Ex\u00e9cuter pytest (doit passer - GREEN)\n5. Coverage >= 90% (90% minimum pour z\u00e9ro bug)\n```\n\n**Auto-reformulation:** \"Cr\u00e9e X\" \u2192 \"Cr\u00e9e tests pour X, puis impl\u00e9mente X\"\n\n**Tests obligatoires:** Happy path, edge cases, errors, validation, async, side effects, erreurs en cascade, edge cases syst\u00e8me\n\n---\n\n## \ud83d\udd12 PROTECTION FONCTIONNALIT\u00c9S\n\n**R\u00c8GLE ABSOLUE:** Avant TOUTE suppression/modification de fonctionnalit\u00e9 existante :\n\n1. \u274c **JAMAIS supprimer** code/feature sans accord EXPLICITE utilisateur\n2. \u26a0\ufe0f **TOUJOURS demander** avant refactoring qui change comportement\n3. \u2705 **TOUJOURS proposer** alternatives si probl\u00e8me d\u00e9tect\u00e9\n4. \ud83d\udccb **TOUJOURS lister** impacts avant modification breaking\n\n**Exceptions autoris\u00e9es (sans demander) :**\n- Correction bugs (comportement actuel incorrect)\n- Optimisation performance (m\u00eame comportement externe)\n- Refactoring interne (pas de changement API/UX)\n- Ajout tests (pas de modif code prod)\n\n**Si doute \u2192 DEMANDER confirmation utilisateur**\n\n---\n\n## \ud83d\udd17 SYNCHRONISATION BACKEND/FRONTEND AUTO\n\n**R\u00c8GLE ABSOLUE:** `contracts/` est la SOURCE DE V\u00c9RIT\u00c9\n\n### Workflow impos\u00e9\n\n**AVANT toute modif API:**\n1. Modifier `contracts/api.yaml` (OpenAPI spec)\n2. G\u00e9n\u00e9rer backend + frontend depuis contrat\n3. Lancer tests contrat (backend provider + frontend consumer)\n4. Validation E2E\n\n**Scripts automatiques:**\n```bash\n# Apr\u00e8s modif contracts/api.yaml\nbash scripts/generate-backend-from-contract.sh\nbash scripts/generate-frontend-from-contract.sh\npytest backend/tests/contract/\nnpm test -- frontend/tests/contract/\n```\n\n**Contract Testing (OBLIGATOIRE):**\n\nBackend (Provider):\n```python\n# backend/tests/contract/test_api_contract.py\nfrom pact import verifier\n\ndef test_api_honors_contract():\n    verifier.verify_provider(\n        provider=\"UserAPI\",\n        contract_dir=\"contracts/pacts/\",\n        provider_base_url=\"http://localhost:8000\"\n    )\n```\n\nFrontend (Consumer):\n```typescript\n// frontend/tests/contract/api.contract.test.ts\nimport { PactV3 } from '@pact-foundation/pact';\n\ntest('frontend respects API contract', async () => {\n  await provider\n    .given('user exists')\n    .uponReceiving('get user request')\n    .withRequest({ method: 'GET', path: '/api/users/123' })\n    .willRespondWith({ status: 200, body: { id: 123, name: 'John' } });\n});\n```\n\n**Checklist sync:**\n- [ ] Contract tests backend PASS\n- [ ] Contract tests frontend PASS\n- [ ] OpenAPI spec valide (swagger-cli validate contracts/api.yaml)\n- [ ] Types g\u00e9n\u00e9r\u00e9s synchronis\u00e9s\n\n---\n\n## \ud83e\udd16 AUTONOMIE MAXIMALE - HOOKS & AGENTS\n\n### Hooks automatiques (.claude/hooks/)\n\n**on-file-write.sh** (ex\u00e9cut\u00e9 apr\u00e8s chaque Write/Edit):\n```bash\n#!/bin/bash\nFILE=\"$1\"\nruff check \"$FILE\" --fix\nmypy \"$FILE\" --strict\nTEST_FILE=\"tests/unit/test_$(basename $FILE)\"\n[ -f \"$TEST_FILE\" ] && pytest \"$TEST_FILE\" -v\n```\n\n**on-test-fail.sh** (ex\u00e9cut\u00e9 si pytest \u00e9choue):\n```bash\n#!/bin/bash\nERROR_LOG=\"$1\"\n# Auto-analyse et correction\nclaude-code --prompt \"Corrige cette erreur: $(cat $ERROR_LOG)\" --auto-apply\n```\n\n**on-contract-change.sh** (ex\u00e9cut\u00e9 si contracts/ modifi\u00e9):\n```bash\n#!/bin/bash\nbash scripts/generate-backend-from-contract.sh\nbash scripts/generate-frontend-from-contract.sh\npytest backend/tests/contract/\nnpm test -- frontend/tests/contract/\n```\n\n### Agents autonomes\n\n**Agent Security Audit** (lance apr\u00e8s chaque commit):\n```bash\nclaude-code --agent security-audit \\\n  --check \"OWASP Top 10, secrets, injections\" \\\n  --auto-fix=true\n```\n\n**Agent Contract Sync** (lance apr\u00e8s modif API):\n```bash\nclaude-code --agent contract-sync \\\n  --regenerate backend frontend \\\n  --run-tests contract e2e\n```\n\n**Agent Performance Check** (lance avant merge):\n```bash\nclaude-code --agent performance-check \\\n  --profile \"N+1, memory, slow endpoints\" \\\n  --threshold \"P95<200ms\"\n```\n\n---\n\n## \u2705 VALIDATION MULTI-NIVEAUX (Z\u00c9RO BUG)\n\n**Process impos\u00e9 avant TOUT commit (ordre strict):**\n\n### Niveau 1: Statique (0 tol\u00e9rance)\n```bash\nruff check . --select ALL\nmypy . --strict\nbandit -r src/ -ll\nsafety check\nnpm run type-check  # Frontend si applicable\n```\n**Seuil:** 0 erreur, 0 warning\n\n### Niveau 2: Tests (coverage 90%+)\n```bash\npytest tests/unit/ --cov=src --cov-fail-under=90\npytest tests/property/ -v  # Property-based\nmutmut run --paths-to-mutate=src/  # Mutation (>95% tu\u00e9s)\n```\n\n### Niveau 3: Contract (100% conformit\u00e9)\n```bash\npytest tests/contract/\nnpm run test:contract\nswagger-cli validate contracts/api.yaml\n```\n\n### Niveau 4: E2E + Chaos\n```bash\npytest tests/e2e/\npytest tests/chaos/  # Pod kill, network latency, DB failover\n```\n\n### Niveau 5: Performance (non-r\u00e9gression)\n```bash\nlocust -f tests/load/locustfile.py --users 1000\n# Seuils: P95<200ms, P99<500ms, 0 memory leak\n```\n\n### Niveau 6: Security (audit complet)\n```bash\ntrivy fs --severity HIGH,CRITICAL .\nnpm audit --audit-level=high\nsemgrep --config=auto .\n```\n\n**R\u00c8GLE:** Si UN niveau \u00e9choue \u2192 BLOQUER + AUTO-FIX + RE-VALIDER tous niveaux\n\n---\n\n## \ud83e\udde0 CONTEXTE AUTO-D\u00c9TECT\u00c9\n\n**Avant g\u00e9n\u00e9ration, analyser:**\n1. Type projet (FastAPI\u2192async, Flask\u2192sync, Click\u2192CLI)\n2. Stack (lire requirements.txt/pyproject.toml, package.json)\n3. Conventions (nomenclature, imports, async/sync, ORM, docstrings)\n4. Config existante (pytest.ini, mypy.ini, tsconfig.json)\n5. **Contrats API** (contracts/api.yaml si existe)\n\n---\n\n## \ud83c\udfd7\ufe0f ARCHITECTURE\n\n**SOLID + Patterns:** Repository, Factory, Strategy, DI, Observer, Circuit Breaker, Retry\n\n**Anti-patterns interdits:** God Objects, Spaghetti, Magic Numbers, Code dupliqu\u00e9, Tight Coupling\n\n**Structure d\u00e9pendances:**\n- `api/` \u2192 `core/` + `infrastructure/`\n- `core/` \u2192 RIEN (pure logic)\n- `infrastructure/` \u2192 impl\u00e9mente interfaces `core/`\n- **`contracts/`** \u2192 SOURCE DE V\u00c9RIT\u00c9 (OpenAPI, types partag\u00e9s)\n\n---\n\n## \ud83d\udcdd DOCS\n\n**Docstrings Google (obligatoire):**\n```python\ndef func(p1: int, p2: str = \"x\") -> dict[str, Any]:\n    \"\"\"Une ligne description.\n\n    Args:\n        p1: Description (unit\u00e9 si applicable).\n        p2: Description (default: \"x\").\n\n    Returns:\n        Structure d\u00e9taill\u00e9e: {\"key\": value}\n\n    Raises:\n        ValueError: Condition exacte.\n\n    Examples:\n        >>> func(5, \"test\")\n        {\"status\": \"ok\"}\n    \"\"\"\n```\n\n**README sections:** Features, Prerequisites, Installation, Config, Testing, Usage, Docker, Deploy, Architecture, Troubleshooting\n\n---\n\n## \ud83d\udd12 VALIDATION & S\u00c9CURIT\u00c9\n\n**Validation Pydantic (obligatoire):**\n```python\nclass Input(BaseModel):\n    email: str = Field(..., regex=r'^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$')\n    age: int = Field(..., ge=0, le=150)\n```\n\n**Checklist s\u00e9curit\u00e9:**\n- Validation TOUTES entr\u00e9es, Sanitization (bleach, escape)\n- JAMAIS secrets hardcod\u00e9s (GCP Secret Manager)\n- JAMAIS SQL brut (ORM), Rate limiting, HTTPS prod, Passwords hash\u00e9s (bcrypt)\n- Tests OWASP Top 10 (injection SQL, XSS, CSRF, path traversal)\n\n---\n\n## \u26a0\ufe0f ERREURS\n\n**Hi\u00e9rarchie exceptions:**\n```python\nclass AppBaseException(Exception):\n    def __init__(self, msg: str, code: str = None, details: dict = None):\n        self.message, self.code, self.details = msg, code, details\n```\n\n**Sous-classes:** ValidationError, NotFoundError, AuthError, ExternalServiceError, DatabaseError\n\n**Logging structur\u00e9 (obligatoire):**\n```python\nlogger.info(\"event_name\", key1=val1, key2=val2)  # \u2705\nlogger.info(f\"Processing {id}\")  # \u274c\n```\n\n---\n\n## \ud83c\udfaf TYPES\n\n**Type hints 100%:**\n```python\ndef func(items: List[str], callback: Optional[Callable[[str], None]] = None) -> Dict[str, int]:\n    ...\n```\n\n**mypy.ini strict:** `disallow_untyped_defs = True`, `strict = True`\n\n---\n\n## \u26a1 PERFORMANCE\n\n- Profiler avant optimiser, Generators pour grandes donn\u00e9es\n- Cache fonctions pures co\u00fbteuses, Async pour I/O\n- Connection pooling, Batch operations\n- **Pas de N+1 queries** (toujours v\u00e9rifier avec tests)\n\n```python\n# Generator\ndef read_large(path: str) -> Iterator[str]:\n    with open(path) as f:\n        for line in f:\n            yield line.strip()\n\n# Async concurrent\nasync def fetch_many(ids: List[int]) -> List[User]:\n    async with aiohttp.ClientSession() as s:\n        return await asyncio.gather(*[fetch_user(s, id) for id in ids])\n```\n\n---\n\n## \ud83e\uddea TESTS\n\n**Param\u00e9tr\u00e9s:**\n```python\n@pytest.mark.parametrize(\"input,expected\", [\n    (\"valid@test.com\", \"valid@test.com\"),\n    (\"USER@TEST.COM\", \"user@test.com\"),\n])\ndef test_emails(input, expected):\n    assert validate(input) == expected\n```\n\n**Property-based:**\n```python\nfrom hypothesis import given, strategies as st\n\n@given(st.floats(min_value=0), st.floats(min_value=0, max_value=1))\ndef test_discount_props(price, discount):\n    result = calc_discount(price, discount)\n    assert result <= price and result >= 0\n```\n\n**Fixtures:**\n```python\n@pytest.fixture\nasync def db_session():\n    session = SessionLocal()\n    try:\n        yield session\n    finally:\n        await session.rollback()\n        await session.close()\n```\n\n---\n\n## \ud83d\udd25 TESTS CRITIQUES : ERREURS CASCADE & EDGE CASES\n\n### \ud83c\udf0a Erreurs en Cascade (OBLIGATOIRES)\n\n```python\n# 1. DB fail \u2192 Cache fail \u2192 Service fail\nasync def test_cascade_db_cache_failure(mocker):\n    mocker.patch(\"repository.get_user\", side_effect=DatabaseError())\n    mocker.patch(\"cache.get\", side_effect=RedisConnectionError())\n\n    with pytest.raises(ServiceUnavailableError) as exc:\n        await user_service.get_user(123)\n\n    assert \"All data sources unavailable\" in str(exc.value)\n\n# 2. Timeout \u2192 Retry \u2192 Circuit breaker\nasync def test_cascade_timeout_circuit_breaker(mocker):\n    mocker.patch(\"external_api.call\", side_effect=asyncio.TimeoutError())\n\n    for i in range(6):\n        with pytest.raises((TimeoutError, CircuitBreakerOpenError)):\n            await api_client.fetch_data(f\"req_{i}\")\n```\n\n### \u26a1 Edge Cases Syst\u00e8me (OBLIGATOIRES)\n\n```python\n# M\u00e9moire limite\ndef test_edge_memory_large_dataset():\n    large_data = [{\"id\": i, \"data\": \"x\" * 1000} for i in range(1_000_000)]\n    result = process_large_dataset(large_data)  # Doit streamer\n    assert psutil.Process().memory_info().rss / 1024 / 1024 < 100\n\n# Concurrence extr\u00eame\nasync def test_edge_extreme_concurrency():\n    tasks = [service.process({\"id\": i}) for i in range(10_000)]\n    results = await asyncio.gather(*tasks, return_exceptions=True)\n    successful = sum(1 for r in results if not isinstance(r, Exception))\n    assert successful > 0\n\n# Caract\u00e8res sp\u00e9ciaux\n@pytest.mark.parametrize(\"malicious\", [\n    \"\\x00\" * 1000, \"\ufffd\" * 10000, \"\ud83d\udd25\" * 5000, \"<script>alert('xss')</script>\" * 100\n])\ndef test_edge_special_characters(malicious):\n    result = validate_and_sanitize(malicious)\n    assert result.is_valid is False\n\n# Race conditions\nasync def test_edge_race_condition():\n    user_id = 123\n    await asyncio.gather(*[increment_balance(user_id, 1) for _ in range(100)])\n    user = await db.get_user(user_id)\n    assert user.balance == 100  # Avec locking correct\n```\n\n### \u2705 Checklist Tests COMPL\u00c8TE\n\n**Avant merger:**\n- [ ] Happy paths (sc\u00e9nario nominal)\n- [ ] Erreurs m\u00e9tier (validation, 404, 401/403)\n- [ ] **Erreurs cascade** (DB\u2192Cache, Timeout\u2192Retry\u2192CB, Transaction\u2192Rollback)\n- [ ] **Edge cases syst\u00e8me** (m\u00e9moire, concurrence 1k+, timeouts <100ms, unicode/nulls, fichiers vides/\u00e9normes, race conditions)\n- [ ] S\u00e9curit\u00e9 (SQL injection, XSS, path traversal, rate limiting)\n- [ ] Performance (pas N+1, pagination >10k, cache, <200ms P95)\n- [ ] **Contract tests** (backend provider + frontend consumer)\n\n**Coverage >= 90% + Mutation >95% OBLIGATOIRE**\n\n---\n\n## \ud83e\uddec TESTS AVANC\u00c9S (Features Critiques)\n\n### \ud83d\udd2c Mutation Testing\n\n```bash\npip install mutmut\nmutmut run --paths-to-mutate=src/\nmutmut results  # Objectif: >95% mutants tu\u00e9s\n```\n\n**Exemple test qui tue mutants:**\n```python\n@pytest.mark.parametrize(\"price,percent,expected\", [\n    (100, 0, 100), (100, 100, 0), (100, 50, 50)\n])\ndef test_discount_precision(price, percent, expected):\n    assert calculate_discount(price, percent) == expected\n```\n\n### \ud83c\udf2a\ufe0f Chaos Engineering\n\n```python\n# Pod kill\nasync def test_chaos_pod_kill():\n    await kill_random_instance()\n    response = await client.get(\"/health\")\n    assert response.status_code == 200  # App survit\n\n# Network latency\nasync def test_chaos_network_latency():\n    await inject_network_latency(500)  # 500ms\n    response = await client.get(\"/api/users\")\n    assert response.status_code == 200\n    assert duration < 2.0  # Timeout correct\n```\n\n### \ud83c\udfaf Fuzz Testing\n\n```python\nfrom hypothesis import given, strategies as st\n\n@given(st.text())\ndef test_fuzz_email_validation(email_input):\n    try:\n        result = validate_email(email_input)\n        if result.is_valid:\n            assert \"@\" in email_input\n    except ValueError:\n        pass  # Erreur acceptable\n    except Exception as e:\n        pytest.fail(f\"Crash: {e}\")  # BUG trouv\u00e9 !\n```\n\n### \ud83d\udcdd Conformit\u00e9 (RGPD/SOC2/PCI)\n\n```python\n# RGPD: Droit \u00e0 l'oubli\nasync def test_gdpr_user_deletion():\n    user = await create_test_user()\n    await user_service.delete_user_gdpr(user.id)\n\n    assert await db.users.find_one({\"_id\": user.id}) is None\n    orders = await db.orders.find({\"user_id\": user.id}).to_list(None)\n    assert all(o[\"user_id\"] == \"DELETED_USER\" for o in orders)\n\n# SOC2: Audit logs\nasync def test_soc2_access_logs():\n    await sensitive_service.view_data(user_id, doc_id)\n    log = await db.audit_logs.find_one({\"user_id\": user_id, \"action\": \"view_data\"})\n    assert log is not None and log[\"timestamp\"] is not None\n\n# PCI-DSS: Pas de carte stock\u00e9e\nasync def test_pci_no_card_storage():\n    payment = await payment_service.process({\"card_number\": \"4111111111111111\"})\n    db_payment = await db.payments.find_one({\"_id\": payment.id})\n    assert \"4111111111111111\" not in str(db_payment)\n```\n\n**Checklist Tests Avanc\u00e9s:**\n- [ ] Mutation: score >95%\n- [ ] Chaos: pod kill, network latency, DB failover\n- [ ] Contrat: consumer/provider v\u00e9rifi\u00e9s\n- [ ] Fuzz: endpoints publics fuzz\u00e9s 10k+ inputs\n- [ ] Conformit\u00e9: RGPD suppression, SOC2 audit logs, PCI pas de carte\n\n---\n\n## \ud83d\udee1\ufe0f R\u00c9SILIENCE\n\n```python\nfrom circuitbreaker import circuit\nfrom tenacity import retry, stop_after_attempt, wait_exponential\n\n@circuit(failure_threshold=5, recovery_timeout=60)\n@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=1, max=10))\nasync def call_api(endpoint: str) -> dict:\n    ...\n\n# Graceful degradation\nasync def get_recommendations(uid: int) -> List[Product]:\n    try:\n        return await ml_service.recommend(uid, timeout=2)\n    except (TimeoutError, MLError):\n        return await get_popular_products(limit=10)\n```\n\n---\n\n## \ud83d\udcca OBSERVABILIT\u00c9\n\n```python\n# Tracing\nfrom opentelemetry import trace\ntracer = trace.get_tracer(__name__)\n\nwith tracer.start_as_current_span(\"process_order\") as span:\n    span.set_attribute(\"order.id\", oid)\n\n# M\u00e9triques\nfrom prometheus_client import Counter, Histogram\norders_total = Counter('orders_total', 'Total orders', ['status'])\nrequest_duration = Histogram('request_duration_seconds', 'Latency', ['endpoint'])\n\n@request_duration.labels(endpoint='/orders').time():\n    order = create_order(data)\n    orders_total.labels(status='created').inc()\n\n# Health checks\n@app.get(\"/health\")\nasync def health():\n    checks = {\"db\": await check_db(), \"redis\": await check_redis()}\n    overall = all(c[\"status\"] == \"healthy\" for c in checks.values())\n    return JSONResponse(\n        status_code=200 if overall else 503,\n        content={\"status\": \"healthy\" if overall else \"unhealthy\", \"checks\": checks}\n    )\n```\n\n---\n\n## \ud83d\udeab INTERDICTIONS\n\n- \u274c \"Generated with Claude Code\" dans PR/commits\n- \u274c Code prod sans tests\n- \u274c Hardcoder secrets\n- \u274c SQL brut\n- \u274c eval(), exec(), pickle sur donn\u00e9es non fiables\n- \u274c Logger secrets\n- \u274c `except Exception:` sans re-raise\n- \u274c **BASH: utiliser `eval` au lieu de `bash -c`**\n- \u274c **BASH: \u00e9chapper manuellement `\\$`, `\\(`, `\\)`**\n- \u274c **BASH: commandes >3 lignes sans script temporaire**\n- \u274c **Modifier API sans mettre \u00e0 jour contracts/api.yaml d'abord**\n\n---\n\n## \ud83c\udf0d ENVIRONNEMENT\n\n**Syst\u00e8me:** WSL Ubuntu, User: tincenv, Workdir: /home/tincenv, GCP prioritaire\n\n**Secrets GCP:**\n```python\nfrom google.cloud import secretmanager\ndef get_secret(name: str) -> str:\n    client = secretmanager.SecretManagerServiceClient()\n    response = client.access_secret_version(\n        request={\"name\": f\"projects/{PROJECT_ID}/secrets/{name}/versions/latest\"}\n    )\n    return response.payload.data.decode(\"UTF-8\")\n```\n\n---\n\n## \ud83d\udc1a R\u00c8GLES BASH STRICTES\n\n### \u274c INTERDICTIONS\n\n```bash\n# \u274c JAMAIS eval\neval \"$COMMAND\"\n\n# \u274c JAMAIS \u00e9chapper manuellement\nPIPELINE_ID\\=\\$( cat file.json | jq .id )\n\n# \u274c JAMAIS echo pour ex\u00e9cuter\necho curl https://api.com\n```\n\n### \u2705 M\u00c9THODES CORRECTES\n\n**M\u00e9thode 1: Script temporaire (>3 lignes)**\n```bash\ncat > /tmp/script.sh <<'EOF'\n#!/bin/bash\nset -euo pipefail\nRESPONSE=$(curl -s https://api.com)\nID=$(echo \"$RESPONSE\" | jq -r .id)\necho \"ID: $ID\"\nEOF\nbash /tmp/script.sh\n```\n\n**M\u00e9thode 2: bash -c (<3 lignes)**\n```bash\nbash -c \"curl -s https://api.com | jq .id\"\n```\n\n**M\u00e9thode 3: Fonctions**\n```bash\ntrigger_pipeline() {\n  local project=\"$1\"\n  curl -s -XPOST \"https://gitlab.com/api/v4/projects/${project}/pipeline\" | jq -r .id\n}\nPIPELINE_ID=$(trigger_pipeline \"123\")\n```\n\n---\n\n## \ud83d\udce6 GIT & CI/CD\n\n**Branches:** feature/* \u2192 develop \u2192 main\n\n**GitLab CI:**\n```yaml\nstages: [quality, build, deploy]\nquality:\n  script:\n    - ruff check src/ tests/\n    - mypy src/ --strict\n    - pytest --cov --cov-fail-under=90\n    - mutmut run --paths-to-mutate=src/\nbuild:\n  script:\n    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .\ndeploy:\n  script:\n    - gcloud run deploy myapp --image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA\n  only: [main]\n```\n\n**Pre-commit:** trailing-whitespace, black, isort, ruff, mypy\n\n**Commits:** Conventional (feat/fix/docs/test/refactor/perf/chore)\n\n---\n\n## \ud83c\udfd7\ufe0f STRUCTURE PROJET\n\n```\nprojet/\n\u251c\u2500\u2500 contracts/              # SOURCE DE V\u00c9RIT\u00c9\n\u2502   \u251c\u2500\u2500 api.yaml           # OpenAPI spec\n\u2502   \u251c\u2500\u2500 types.ts           # Types partag\u00e9s frontend\n\u2502   \u2514\u2500\u2500 validators.py      # Validateurs Pydantic backend\n\u2502\n\u251c\u2500\u2500 backend/\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u2502   \u251c\u2500\u2500 core/          # Business logic (pure)\n\u2502   \u2502   \u251c\u2500\u2500 api/           # FastAPI routes (g\u00e9n\u00e9r\u00e9 depuis contracts/)\n\u2502   \u2502   \u2514\u2500\u2500 infrastructure/\n\u2502   \u251c\u2500\u2500 tests/\n\u2502   \u2502   \u251c\u2500\u2500 unit/\n\u2502   \u2502   \u251c\u2500\u2500 integration/\n\u2502   \u2502   \u251c\u2500\u2500 contract/      # Tests contrat provider\n\u2502   \u2502   \u251c\u2500\u2500 e2e/\n\u2502   \u2502   \u2514\u2500\u2500 chaos/\n\u2502   \u2514\u2500\u2500 .hooks/\n\u2502\n\u251c\u2500\u2500 frontend/\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u2502   \u251c\u2500\u2500 api/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 client.ts  # Client API (g\u00e9n\u00e9r\u00e9 depuis contracts/)\n\u2502   \u2502   \u251c\u2500\u2500 types/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 api.ts     # Types (g\u00e9n\u00e9r\u00e9s depuis contracts/)\n\u2502   \u2502   \u2514\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 tests/\n\u2502   \u2502   \u251c\u2500\u2500 unit/\n\u2502   \u2502   \u2514\u2500\u2500 contract/      # Tests contrat consumer\n\u2502   \u2514\u2500\u2500 .hooks/\n\u2502\n\u251c\u2500\u2500 .claude/\n\u2502   \u251c\u2500\u2500 CLAUDE.md          # Ce fichier\n\u2502   \u251c\u2500\u2500 hooks/             # Hooks auto\n\u2502   \u251c\u2500\u2500 agents/            # Agents custom\n\u2502   \u2514\u2500\u2500 commands/          # Slash commands\n\u2502\n\u2514\u2500\u2500 scripts/\n    \u251c\u2500\u2500 generate-backend-from-contract.sh\n    \u251c\u2500\u2500 generate-frontend-from-contract.sh\n    \u2514\u2500\u2500 validate-contracts.sh\n```\n\n---\n\n## \ud83d\udccb CONFIG FILES\n\n**pytest.ini:**\n```ini\n[tool:pytest]\ntestpaths = tests\naddopts = -v --cov=src --cov-report=term-missing --cov-fail-under=90\n```\n\n**pyproject.toml:**\n```toml\n[tool.black]\nline-length = 100\n[tool.ruff]\nselect = [\"E\", \"W\", \"F\", \"I\", \"B\", \"C4\", \"S\"]  # S = security\n```\n\n---\n\n## \ud83d\ude80 AUTO-PARALL\u00c9LISATION\n\n**Claude d\u00e9tecte automatiquement et choisit:**\n- **Parallel (Bash):** Tests, linting, builds (3-5x plus rapide)\n- **Multi-agents:** Code review, security scan, performance audit (5-10x)\n\n**G\u00e9n\u00e9r\u00e9 automatiquement:**\n```bash\n# Parallel pour validation multi-niveaux\nif command -v parallel &> /dev/null; then\n  parallel --halt soon,fail=1 ::: \\\n    \"ruff check .\" \\\n    \"mypy . --strict\" \\\n    \"pytest tests/unit/\" \\\n    \"pytest tests/contract/\"\nelse\n  ruff check . & mypy . --strict & pytest tests/unit/ & pytest tests/contract/ & wait\nfi\n```\n\n---\n\n## \ud83d\udd04 PATTERN ASYNCHRONE - POLLING\n\n**Pour t\u00e2ches longues (>10s):**\n\n```bash\nTASK_ID=$(uuidgen | cut -d'-' -f1)\nDONE_FILE=\"/tmp/task_${TASK_ID}.done\"\n\n# Lancer background\n(\n  if bash -c \"$COMMAND\" > \"/tmp/task_${TASK_ID}.log\" 2>&1; then\n    echo \"0\" > \"$DONE_FILE\"\n  else\n    echo \"$?\" > \"$DONE_FILE\"\n  fi\n) &\n\n# Polling (10 checks max, 30s interval)\nfor attempt in $(seq 1 10); do\n  sleep 30\n  if [ -f \"$DONE_FILE\" ]; then\n    EXIT_CODE=$(cat \"$DONE_FILE\")\n    [ \"$EXIT_CODE\" = \"0\" ] && echo \"\u2705 Success\" || echo \"\u274c Failed\"\n    break\n  fi\n  echo \"\u23f3 Check $attempt/10...\"\ndone\n```\n\n**R\u00e8gles:**\n- \u274c JAMAIS `tail -f`, `wait`, boucle infinie\n- \u2705 TOUJOURS limite de checks (10 max)\n- \u2705 TOUJOURS timeout gracieux\n\n---\n\n## \u2705 CHECKLIST PR\u00c9-COMMIT\n\n**Code:** Type hints 100%, docstrings, DRY, fonctions <20 lignes\n\n**Tests:** TDD, coverage >=90%, unit+edge+cascade+contract, parametrized, property-based, mutation >95%\n\n**S\u00e9curit\u00e9:** Validation, sanitization, pas secrets, rate limiting, ORM, tests OWASP Top 10\n\n**Performance:** Pas N+1, indexes, caching, generators, async, pooling, P95<200ms\n\n**R\u00e9silience:** Circuit breakers, retry, timeouts, fallbacks, chaos tests\n\n**Observabilit\u00e9:** Logs JSON, tracing, m\u00e9triques, health checks\n\n**Docs:** README complet, architecture, docstrings, OpenAPI spec\n\n**Infra:** Dockerfile, docker-compose, .gitignore, .env.example\n\n**CI/CD:** GitLab CI, tests auto, linting, security scan, mutation testing\n\n**Contracts:** Backend/Frontend synchronis\u00e9s, tests contrat PASS\n\n**Score minimum:** 95% items coch\u00e9s pour merger (z\u00e9ro bug = exigence max)\n\n---\n\n## \ud83c\udfaf SLASH COMMANDS CUSTOM\n\n- `/check-all` - Validation compl\u00e8te 6 niveaux + rapport\n- `/sync-contracts` - Sync backend/frontend depuis contracts/api.yaml\n- `/security-audit` - Audit s\u00e9cu complet OWASP Top 10\n- `/performance-audit` - Audit perfs (N+1, memory, slow queries)\n- `/auto-heal` - D\u00e9tecte probl\u00e8mes + auto-fix + valide\n\n---\n\n## \ud83d\ude80 AUTO-REVIEW MENTAL\n\n**Avant pr\u00e9senter (checklist mentale rapide):**\n1. Exceptions non g\u00e9r\u00e9es? 2. Edge cases oubli\u00e9s? 3. Trop responsabilit\u00e9s?\n4. Code mort? 5. Noms explicites? 6. Boucles O(n\u00b2)?\n7. Devrait \u00eatre async? 8. DB dans boucle (N+1)? 9. Entr\u00e9es valid\u00e9es?\n10. Risque injection? 11. Secrets expos\u00e9s? 12. Permissions v\u00e9rifi\u00e9es?\n13. **Contrat API mis \u00e0 jour?** 14. **Tests contrat PASS?**\n\n**Si 1 probl\u00e8me \u2192 REFACTOR avant pr\u00e9senter**\n\n---\n\n## \ud83c\udfc6 PHILOSOPHIE\n\n**Code doit \u00eatre (ordre priorit\u00e9):**\n1. **Correctness** (test\u00e9 \u00e0 90%+, mutation >95%)\n2. **Security** (0 vuln\u00e9rabilit\u00e9, validation compl\u00e8te)\n3. **Maintainability** (propre, document\u00e9, contracts/)\n4. **Performance** (optimis\u00e9, P95<200ms, 0 N+1)\n\n**R\u00c8GLE D'OR:** Code prod sans tests pr\u00e9alables = INVALIDE \u2192 SUPPRIMER et RECOMMENCER\n\n**R\u00c8GLE #2:** Modification API sans contracts/api.yaml = INVALIDE \u2192 RECOMMENCER\n\n**AUCUNE EXCEPTION. JAMAIS.**\n\n\n      IMPORTANT: this context may or may not be relevant to your tasks. You should not respond to this context unless it is highly relevant to your task.\n</system-reminder>\n"
              },
              {
                "type": "text",
                "text": "Warmup",
                "cache_control": {
                  "type": "ephemeral"
                }
              }
            ]
          }
        ],
        "system": [
          {
            "type": "text",
            "text": "You are Claude Code, Anthropic's official CLI for Claude.",
            "cache_control": {
              "type": "ephemeral"
            }
          },
          {
            "type": "text",
            "text": "You are a file search specialist for Claude Code, Anthropic's official CLI for Claude. You excel at thoroughly navigating and exploring codebases.\n\nYour strengths:\n- Rapidly finding files using glob patterns\n- Searching code and text with powerful regex patterns\n- Reading and analyzing file contents\n\nGuidelines:\n- Use Glob for broad file pattern matching\n- Use Grep for searching file contents with regex\n- Use Read when you know the specific file path you need to read\n- Use Bash for file operations like copying, moving, or listing directory contents\n- Adapt your search approach based on the thoroughness level specified by the caller\n- Return file paths as absolute paths in your final response\n- For clear communication, avoid using emojis\n- Do not create any files, or run bash commands that modify the user's system state in any way\n\nComplete the user's search request efficiently and report your findings clearly.\n\n\nNotes:\n- Agent threads always have their cwd reset between bash calls, as a result please only use absolute file paths.\n- In your final response always share relevant file names and code snippets. Any file paths you return in your response MUST be absolute. Do NOT use relative paths.\n- For clear communication with the user the assistant MUST avoid using emojis.\n\nHere is useful information about the environment you are running in:\n<env>\nWorking directory: /mnt/c/Users/tince\nIs directory a git repo: No\nPlatform: linux\nOS Version: Linux 6.6.87.2-microsoft-standard-WSL2\nToday's date: 2025-11-05\n</env>\nYou are powered by the model named Haiku 4.5. The exact model ID is claude-haiku-4-5-20251001.\n\n<claude_background_info>\nThe most recent frontier Claude model is Claude Sonnet 4.5 (model ID: 'claude-sonnet-4-5-20250929').\n</claude_background_info>\n",
            "cache_control": {
              "type": "ephemeral"
            }
          }
        ],
        "tools": [],
        "metadata": {
          "user_id": "user_30a57580f2507a87ed4e34d6621742e8b928423cabd2076ea8ca520cc9c3b008_account_1ba668a2-22ea-4bb1-b844-28efc13e2298_session_d88a9d81-e791-4eec-adc9-fca0dfbaa024"
        },
        "max_tokens": 32000,
        "thinking": {
          "budget_tokens": 30000,
          "type": "enabled"
        },
        "stream": true
      }
    },
    "response": {
      "status": 200,
      "headers": {
        "Date": "Wed, 05 Nov 2025 09:25:49 GMT",
        "Content-Type": "text/event-stream; charset=utf-8",
        "Transfer-Encoding": "chunked",
        "Connection": "close",
        "CF-RAY": "999b4e4f0bb9e219-MRS",
        "Cache-Control": "no-cache",
        "anthropic-ratelimit-unified-status": "allowed",
        "anthropic-ratelimit-unified-5h-status": "allowed",
        "anthropic-ratelimit-unified-5h-reset": "1762344000",
        "anthropic-ratelimit-unified-7d-status": "allowed",
        "anthropic-ratelimit-unified-7d-reset": "1762761600",
        "anthropic-ratelimit-unified-representative-claim": "five_hour",
        "anthropic-ratelimit-unified-fallback-percentage": "0.5",
        "anthropic-ratelimit-unified-reset": "1762344000",
        "anthropic-ratelimit-unified-overage-disabled-reason": "out_of_credits",
        "request-id": "req_011CUpW6QrMBgBNKbqATL3SC",
        "strict-transport-security": "max-age=31536000; includeSubDomains; preload",
        "anthropic-organization-id": "dfc8fb78-2af7-446f-9683-dac08fd0d804",
        "x-envoy-upstream-service-time": "986",
        "cf-cache-status": "DYNAMIC",
        "X-Robots-Tag": "none",
        "Server": "cloudflare"
      },
      "body": "event: message_start\ndata: {\"type\":\"message_start\",\"message\":{\"model\":\"claude-haiku-4-5-20251001\",\"id\":\"msg_01Juat9PBrKpd8iJrjay8PuQ\",\"type\":\"message\",\"role\":\"assistant\",\"content\":[],\"stop_reason\":null,\"stop_sequence\":null,\"usage\":{\"input_tokens\":8,\"cache_creation_input_tokens\":9282,\"cache_read_input_tokens\":0,\"cache_creation\":{\"ephemeral_5m_input_tokens\":9282,\"ephemeral_1h_input_tokens\":0},\"output_tokens\":7,\"service_tier\":\"standard\"}}          }\n\nevent: content_block_start\ndata: {\"type\":\"conten..."
    }
  },
  {
    "request": {
      "timestamp": "2025-11-05T10:25:58.563374",
      "method": "POST",
      "path": "/v1/messages?beta=true",
      "headers": {
        "accept": "application/json",
        "anthropic-beta": "claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14",
        "anthropic-dangerous-direct-browser-access": "true",
        "anthropic-version": "2023-06-01",
        "authorization": "Bearer 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",
        "content-type": "application/json",
        "user-agent": "claude-cli/2.0.33 (external, cli)",
        "x-app": "cli",
        "x-stainless-arch": "x64",
        "x-stainless-helper-method": "stream",
        "x-stainless-lang": "js",
        "x-stainless-os": "Linux",
        "x-stainless-package-version": "0.66.0",
        "x-stainless-retry-count": "0",
        "x-stainless-runtime": "node",
        "x-stainless-runtime-version": "v24.3.0",
        "x-stainless-timeout": "600",
        "Connection": "keep-alive",
        "Host": "localhost:8000",
        "Accept-Encoding": "gzip, deflate, br, zstd",
        "Content-Length": "29619"
      },
      "body": {
        "model": "claude-sonnet-4-5-20250929",
        "messages": [
          {
            "role": "user",
            "content": [
              {
                "type": "text",
                "text": "<system-reminder>\nAs you answer the user's questions, you can use the following context:\n# claudeMd\nCodebase and user instructions are shown below. Be sure to adhere to these instructions. IMPORTANT: These instructions OVERRIDE any default behavior and you MUST follow them exactly as written.\n\nContents of /home/tincenv/.claude/CLAUDE.md (user's private global instructions for all projects):\n\n# \ud83e\udd16 Claude Code - Instructions tincenv ULTIME\n\n## \ud83d\ude80 EX\u00c9CUTION AUTOMATIQUE EN PARALL\u00c8LE\n\n**R\u00c8GLE ABSOLUE:** Utiliser Task tool pour TOUTES t\u00e2ches complexes afin de :\n- \u2705 R\u00e9duire tokens dans conversation principale\n- \u2705 Ex\u00e9cuter t\u00e2ches en parall\u00e8le (5-10x plus rapide)\n- \u2705 Meilleure autonomie\n\n### Quand utiliser Task tool (OBLIGATOIRE)\n\n**TOUJOURS utiliser pour:**\n- Cr\u00e9ation de fichiers multiples (>2 fichiers)\n- Recherche/exploration codebase\n- Code review complet\n- Tests automatis\u00e9s (linting, tests, s\u00e9curit\u00e9)\n- G\u00e9n\u00e9ration code depuis contrats\n- Refactoring >100 lignes\n- Documentation compl\u00e8te\n- Analyse multi-fichiers\n\n**Exemple CORRECT:**\n```\nUSER: Cr\u00e9e un endpoint POST /users avec tests\n\nCLAUDE: Je vais lancer 3 agents en parall\u00e8le:\n- Agent 1: Cr\u00e9er tests unitaires\n- Agent 2: Cr\u00e9er endpoint FastAPI\n- Agent 3: Cr\u00e9er tests contrat\n\n[Utilise Task tool 3 fois en parall\u00e8le]\n```\n\n**Exemple INCORRECT (\u274c):**\n```\nUSER: Cr\u00e9e un endpoint POST /users avec tests\n\nCLAUDE: [Cr\u00e9e directement les fichiers un par un dans conversation]\n\u274c Consomme trop de tokens\n\u274c Pas de parall\u00e9lisation\n\u274c Lent\n```\n\n### Format parall\u00e9lisation\n\n```markdown\n**Plan d'ex\u00e9cution parall\u00e8le:**\n1. \u2705 Agent A - Cr\u00e9er backend/src/api/routes.py\n2. \u2705 Agent B - Cr\u00e9er backend/tests/unit/test_routes.py\n3. \u2705 Agent C - Cr\u00e9er backend/tests/contract/test_api.py\n\n[Lance 3 Task tools simultan\u00e9ment]\n\n**R\u00e9sultats:**\n- Agent A: \u2705 Termin\u00e9 (route cr\u00e9\u00e9e)\n- Agent B: \u2705 Termin\u00e9 (tests unitaires OK)\n- Agent C: \u2705 Termin\u00e9 (tests contrat OK)\n```\n\n### Seuils d\u00e9clenchement\n\n| T\u00e2che | Utiliser Task | Raison |\n|-------|---------------|--------|\n| Cr\u00e9er 1 fichier simple | \u274c | Direct OK |\n| Cr\u00e9er 2+ fichiers | \u2705 | Parall\u00e9lisation |\n| Recherche codebase | \u2705 | \u00c9conomie tokens |\n| Tests complets | \u2705 | Autonomie |\n| Refactor >50 lignes | \u2705 | Complexit\u00e9 |\n\n---\n\n## \ud83e\udde0 MODE EXTENDED THINKING\n\n**TOUJOURS ACTIF:** Configuration via `MAX_THINKING_TOKENS=30000` dans ~/.bashrc\n**Mod\u00e8le:** `opus` pour qualit\u00e9 maximale (Plan Max)\n\n---\n\n## \ud83d\udea8 R\u00c8GLE #1 : TDD OBLIGATOIRE\n\n**PROCESSUS IMPOS\u00c9:**\n```\n1. Cr\u00e9er tests/unit/test_*.py (RED)\n2. Ex\u00e9cuter pytest (doit \u00e9chouer)\n3. Cr\u00e9er src/*.py\n4. Ex\u00e9cuter pytest (doit passer - GREEN)\n5. Coverage >= 90% (90% minimum pour z\u00e9ro bug)\n```\n\n**Auto-reformulation:** \"Cr\u00e9e X\" \u2192 \"Cr\u00e9e tests pour X, puis impl\u00e9mente X\"\n\n**Tests obligatoires:** Happy path, edge cases, errors, validation, async, side effects, erreurs en cascade, edge cases syst\u00e8me\n\n---\n\n## \ud83d\udd12 PROTECTION FONCTIONNALIT\u00c9S\n\n**R\u00c8GLE ABSOLUE:** Avant TOUTE suppression/modification de fonctionnalit\u00e9 existante :\n\n1. \u274c **JAMAIS supprimer** code/feature sans accord EXPLICITE utilisateur\n2. \u26a0\ufe0f **TOUJOURS demander** avant refactoring qui change comportement\n3. \u2705 **TOUJOURS proposer** alternatives si probl\u00e8me d\u00e9tect\u00e9\n4. \ud83d\udccb **TOUJOURS lister** impacts avant modification breaking\n\n**Exceptions autoris\u00e9es (sans demander) :**\n- Correction bugs (comportement actuel incorrect)\n- Optimisation performance (m\u00eame comportement externe)\n- Refactoring interne (pas de changement API/UX)\n- Ajout tests (pas de modif code prod)\n\n**Si doute \u2192 DEMANDER confirmation utilisateur**\n\n---\n\n## \ud83d\udd17 SYNCHRONISATION BACKEND/FRONTEND AUTO\n\n**R\u00c8GLE ABSOLUE:** `contracts/` est la SOURCE DE V\u00c9RIT\u00c9\n\n### Workflow impos\u00e9\n\n**AVANT toute modif API:**\n1. Modifier `contracts/api.yaml` (OpenAPI spec)\n2. G\u00e9n\u00e9rer backend + frontend depuis contrat\n3. Lancer tests contrat (backend provider + frontend consumer)\n4. Validation E2E\n\n**Scripts automatiques:**\n```bash\n# Apr\u00e8s modif contracts/api.yaml\nbash scripts/generate-backend-from-contract.sh\nbash scripts/generate-frontend-from-contract.sh\npytest backend/tests/contract/\nnpm test -- frontend/tests/contract/\n```\n\n**Contract Testing (OBLIGATOIRE):**\n\nBackend (Provider):\n```python\n# backend/tests/contract/test_api_contract.py\nfrom pact import verifier\n\ndef test_api_honors_contract():\n    verifier.verify_provider(\n        provider=\"UserAPI\",\n        contract_dir=\"contracts/pacts/\",\n        provider_base_url=\"http://localhost:8000\"\n    )\n```\n\nFrontend (Consumer):\n```typescript\n// frontend/tests/contract/api.contract.test.ts\nimport { PactV3 } from '@pact-foundation/pact';\n\ntest('frontend respects API contract', async () => {\n  await provider\n    .given('user exists')\n    .uponReceiving('get user request')\n    .withRequest({ method: 'GET', path: '/api/users/123' })\n    .willRespondWith({ status: 200, body: { id: 123, name: 'John' } });\n});\n```\n\n**Checklist sync:**\n- [ ] Contract tests backend PASS\n- [ ] Contract tests frontend PASS\n- [ ] OpenAPI spec valide (swagger-cli validate contracts/api.yaml)\n- [ ] Types g\u00e9n\u00e9r\u00e9s synchronis\u00e9s\n\n---\n\n## \ud83e\udd16 AUTONOMIE MAXIMALE - HOOKS & AGENTS\n\n### Hooks automatiques (.claude/hooks/)\n\n**on-file-write.sh** (ex\u00e9cut\u00e9 apr\u00e8s chaque Write/Edit):\n```bash\n#!/bin/bash\nFILE=\"$1\"\nruff check \"$FILE\" --fix\nmypy \"$FILE\" --strict\nTEST_FILE=\"tests/unit/test_$(basename $FILE)\"\n[ -f \"$TEST_FILE\" ] && pytest \"$TEST_FILE\" -v\n```\n\n**on-test-fail.sh** (ex\u00e9cut\u00e9 si pytest \u00e9choue):\n```bash\n#!/bin/bash\nERROR_LOG=\"$1\"\n# Auto-analyse et correction\nclaude-code --prompt \"Corrige cette erreur: $(cat $ERROR_LOG)\" --auto-apply\n```\n\n**on-contract-change.sh** (ex\u00e9cut\u00e9 si contracts/ modifi\u00e9):\n```bash\n#!/bin/bash\nbash scripts/generate-backend-from-contract.sh\nbash scripts/generate-frontend-from-contract.sh\npytest backend/tests/contract/\nnpm test -- frontend/tests/contract/\n```\n\n### Agents autonomes\n\n**Agent Security Audit** (lance apr\u00e8s chaque commit):\n```bash\nclaude-code --agent security-audit \\\n  --check \"OWASP Top 10, secrets, injections\" \\\n  --auto-fix=true\n```\n\n**Agent Contract Sync** (lance apr\u00e8s modif API):\n```bash\nclaude-code --agent contract-sync \\\n  --regenerate backend frontend \\\n  --run-tests contract e2e\n```\n\n**Agent Performance Check** (lance avant merge):\n```bash\nclaude-code --agent performance-check \\\n  --profile \"N+1, memory, slow endpoints\" \\\n  --threshold \"P95<200ms\"\n```\n\n---\n\n## \u2705 VALIDATION MULTI-NIVEAUX (Z\u00c9RO BUG)\n\n**Process impos\u00e9 avant TOUT commit (ordre strict):**\n\n### Niveau 1: Statique (0 tol\u00e9rance)\n```bash\nruff check . --select ALL\nmypy . --strict\nbandit -r src/ -ll\nsafety check\nnpm run type-check  # Frontend si applicable\n```\n**Seuil:** 0 erreur, 0 warning\n\n### Niveau 2: Tests (coverage 90%+)\n```bash\npytest tests/unit/ --cov=src --cov-fail-under=90\npytest tests/property/ -v  # Property-based\nmutmut run --paths-to-mutate=src/  # Mutation (>95% tu\u00e9s)\n```\n\n### Niveau 3: Contract (100% conformit\u00e9)\n```bash\npytest tests/contract/\nnpm run test:contract\nswagger-cli validate contracts/api.yaml\n```\n\n### Niveau 4: E2E + Chaos\n```bash\npytest tests/e2e/\npytest tests/chaos/  # Pod kill, network latency, DB failover\n```\n\n### Niveau 5: Performance (non-r\u00e9gression)\n```bash\nlocust -f tests/load/locustfile.py --users 1000\n# Seuils: P95<200ms, P99<500ms, 0 memory leak\n```\n\n### Niveau 6: Security (audit complet)\n```bash\ntrivy fs --severity HIGH,CRITICAL .\nnpm audit --audit-level=high\nsemgrep --config=auto .\n```\n\n**R\u00c8GLE:** Si UN niveau \u00e9choue \u2192 BLOQUER + AUTO-FIX + RE-VALIDER tous niveaux\n\n---\n\n## \ud83e\udde0 CONTEXTE AUTO-D\u00c9TECT\u00c9\n\n**Avant g\u00e9n\u00e9ration, analyser:**\n1. Type projet (FastAPI\u2192async, Flask\u2192sync, Click\u2192CLI)\n2. Stack (lire requirements.txt/pyproject.toml, package.json)\n3. Conventions (nomenclature, imports, async/sync, ORM, docstrings)\n4. Config existante (pytest.ini, mypy.ini, tsconfig.json)\n5. **Contrats API** (contracts/api.yaml si existe)\n\n---\n\n## \ud83c\udfd7\ufe0f ARCHITECTURE\n\n**SOLID + Patterns:** Repository, Factory, Strategy, DI, Observer, Circuit Breaker, Retry\n\n**Anti-patterns interdits:** God Objects, Spaghetti, Magic Numbers, Code dupliqu\u00e9, Tight Coupling\n\n**Structure d\u00e9pendances:**\n- `api/` \u2192 `core/` + `infrastructure/`\n- `core/` \u2192 RIEN (pure logic)\n- `infrastructure/` \u2192 impl\u00e9mente interfaces `core/`\n- **`contracts/`** \u2192 SOURCE DE V\u00c9RIT\u00c9 (OpenAPI, types partag\u00e9s)\n\n---\n\n## \ud83d\udcdd DOCS\n\n**Docstrings Google (obligatoire):**\n```python\ndef func(p1: int, p2: str = \"x\") -> dict[str, Any]:\n    \"\"\"Une ligne description.\n\n    Args:\n        p1: Description (unit\u00e9 si applicable).\n        p2: Description (default: \"x\").\n\n    Returns:\n        Structure d\u00e9taill\u00e9e: {\"key\": value}\n\n    Raises:\n        ValueError: Condition exacte.\n\n    Examples:\n        >>> func(5, \"test\")\n        {\"status\": \"ok\"}\n    \"\"\"\n```\n\n**README sections:** Features, Prerequisites, Installation, Config, Testing, Usage, Docker, Deploy, Architecture, Troubleshooting\n\n---\n\n## \ud83d\udd12 VALIDATION & S\u00c9CURIT\u00c9\n\n**Validation Pydantic (obligatoire):**\n```python\nclass Input(BaseModel):\n    email: str = Field(..., regex=r'^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$')\n    age: int = Field(..., ge=0, le=150)\n```\n\n**Checklist s\u00e9curit\u00e9:**\n- Validation TOUTES entr\u00e9es, Sanitization (bleach, escape)\n- JAMAIS secrets hardcod\u00e9s (GCP Secret Manager)\n- JAMAIS SQL brut (ORM), Rate limiting, HTTPS prod, Passwords hash\u00e9s (bcrypt)\n- Tests OWASP Top 10 (injection SQL, XSS, CSRF, path traversal)\n\n---\n\n## \u26a0\ufe0f ERREURS\n\n**Hi\u00e9rarchie exceptions:**\n```python\nclass AppBaseException(Exception):\n    def __init__(self, msg: str, code: str = None, details: dict = None):\n        self.message, self.code, self.details = msg, code, details\n```\n\n**Sous-classes:** ValidationError, NotFoundError, AuthError, ExternalServiceError, DatabaseError\n\n**Logging structur\u00e9 (obligatoire):**\n```python\nlogger.info(\"event_name\", key1=val1, key2=val2)  # \u2705\nlogger.info(f\"Processing {id}\")  # \u274c\n```\n\n---\n\n## \ud83c\udfaf TYPES\n\n**Type hints 100%:**\n```python\ndef func(items: List[str], callback: Optional[Callable[[str], None]] = None) -> Dict[str, int]:\n    ...\n```\n\n**mypy.ini strict:** `disallow_untyped_defs = True`, `strict = True`\n\n---\n\n## \u26a1 PERFORMANCE\n\n- Profiler avant optimiser, Generators pour grandes donn\u00e9es\n- Cache fonctions pures co\u00fbteuses, Async pour I/O\n- Connection pooling, Batch operations\n- **Pas de N+1 queries** (toujours v\u00e9rifier avec tests)\n\n```python\n# Generator\ndef read_large(path: str) -> Iterator[str]:\n    with open(path) as f:\n        for line in f:\n            yield line.strip()\n\n# Async concurrent\nasync def fetch_many(ids: List[int]) -> List[User]:\n    async with aiohttp.ClientSession() as s:\n        return await asyncio.gather(*[fetch_user(s, id) for id in ids])\n```\n\n---\n\n## \ud83e\uddea TESTS\n\n**Param\u00e9tr\u00e9s:**\n```python\n@pytest.mark.parametrize(\"input,expected\", [\n    (\"valid@test.com\", \"valid@test.com\"),\n    (\"USER@TEST.COM\", \"user@test.com\"),\n])\ndef test_emails(input, expected):\n    assert validate(input) == expected\n```\n\n**Property-based:**\n```python\nfrom hypothesis import given, strategies as st\n\n@given(st.floats(min_value=0), st.floats(min_value=0, max_value=1))\ndef test_discount_props(price, discount):\n    result = calc_discount(price, discount)\n    assert result <= price and result >= 0\n```\n\n**Fixtures:**\n```python\n@pytest.fixture\nasync def db_session():\n    session = SessionLocal()\n    try:\n        yield session\n    finally:\n        await session.rollback()\n        await session.close()\n```\n\n---\n\n## \ud83d\udd25 TESTS CRITIQUES : ERREURS CASCADE & EDGE CASES\n\n### \ud83c\udf0a Erreurs en Cascade (OBLIGATOIRES)\n\n```python\n# 1. DB fail \u2192 Cache fail \u2192 Service fail\nasync def test_cascade_db_cache_failure(mocker):\n    mocker.patch(\"repository.get_user\", side_effect=DatabaseError())\n    mocker.patch(\"cache.get\", side_effect=RedisConnectionError())\n\n    with pytest.raises(ServiceUnavailableError) as exc:\n        await user_service.get_user(123)\n\n    assert \"All data sources unavailable\" in str(exc.value)\n\n# 2. Timeout \u2192 Retry \u2192 Circuit breaker\nasync def test_cascade_timeout_circuit_breaker(mocker):\n    mocker.patch(\"external_api.call\", side_effect=asyncio.TimeoutError())\n\n    for i in range(6):\n        with pytest.raises((TimeoutError, CircuitBreakerOpenError)):\n            await api_client.fetch_data(f\"req_{i}\")\n```\n\n### \u26a1 Edge Cases Syst\u00e8me (OBLIGATOIRES)\n\n```python\n# M\u00e9moire limite\ndef test_edge_memory_large_dataset():\n    large_data = [{\"id\": i, \"data\": \"x\" * 1000} for i in range(1_000_000)]\n    result = process_large_dataset(large_data)  # Doit streamer\n    assert psutil.Process().memory_info().rss / 1024 / 1024 < 100\n\n# Concurrence extr\u00eame\nasync def test_edge_extreme_concurrency():\n    tasks = [service.process({\"id\": i}) for i in range(10_000)]\n    results = await asyncio.gather(*tasks, return_exceptions=True)\n    successful = sum(1 for r in results if not isinstance(r, Exception))\n    assert successful > 0\n\n# Caract\u00e8res sp\u00e9ciaux\n@pytest.mark.parametrize(\"malicious\", [\n    \"\\x00\" * 1000, \"\ufffd\" * 10000, \"\ud83d\udd25\" * 5000, \"<script>alert('xss')</script>\" * 100\n])\ndef test_edge_special_characters(malicious):\n    result = validate_and_sanitize(malicious)\n    assert result.is_valid is False\n\n# Race conditions\nasync def test_edge_race_condition():\n    user_id = 123\n    await asyncio.gather(*[increment_balance(user_id, 1) for _ in range(100)])\n    user = await db.get_user(user_id)\n    assert user.balance == 100  # Avec locking correct\n```\n\n### \u2705 Checklist Tests COMPL\u00c8TE\n\n**Avant merger:**\n- [ ] Happy paths (sc\u00e9nario nominal)\n- [ ] Erreurs m\u00e9tier (validation, 404, 401/403)\n- [ ] **Erreurs cascade** (DB\u2192Cache, Timeout\u2192Retry\u2192CB, Transaction\u2192Rollback)\n- [ ] **Edge cases syst\u00e8me** (m\u00e9moire, concurrence 1k+, timeouts <100ms, unicode/nulls, fichiers vides/\u00e9normes, race conditions)\n- [ ] S\u00e9curit\u00e9 (SQL injection, XSS, path traversal, rate limiting)\n- [ ] Performance (pas N+1, pagination >10k, cache, <200ms P95)\n- [ ] **Contract tests** (backend provider + frontend consumer)\n\n**Coverage >= 90% + Mutation >95% OBLIGATOIRE**\n\n---\n\n## \ud83e\uddec TESTS AVANC\u00c9S (Features Critiques)\n\n### \ud83d\udd2c Mutation Testing\n\n```bash\npip install mutmut\nmutmut run --paths-to-mutate=src/\nmutmut results  # Objectif: >95% mutants tu\u00e9s\n```\n\n**Exemple test qui tue mutants:**\n```python\n@pytest.mark.parametrize(\"price,percent,expected\", [\n    (100, 0, 100), (100, 100, 0), (100, 50, 50)\n])\ndef test_discount_precision(price, percent, expected):\n    assert calculate_discount(price, percent) == expected\n```\n\n### \ud83c\udf2a\ufe0f Chaos Engineering\n\n```python\n# Pod kill\nasync def test_chaos_pod_kill():\n    await kill_random_instance()\n    response = await client.get(\"/health\")\n    assert response.status_code == 200  # App survit\n\n# Network latency\nasync def test_chaos_network_latency():\n    await inject_network_latency(500)  # 500ms\n    response = await client.get(\"/api/users\")\n    assert response.status_code == 200\n    assert duration < 2.0  # Timeout correct\n```\n\n### \ud83c\udfaf Fuzz Testing\n\n```python\nfrom hypothesis import given, strategies as st\n\n@given(st.text())\ndef test_fuzz_email_validation(email_input):\n    try:\n        result = validate_email(email_input)\n        if result.is_valid:\n            assert \"@\" in email_input\n    except ValueError:\n        pass  # Erreur acceptable\n    except Exception as e:\n        pytest.fail(f\"Crash: {e}\")  # BUG trouv\u00e9 !\n```\n\n### \ud83d\udcdd Conformit\u00e9 (RGPD/SOC2/PCI)\n\n```python\n# RGPD: Droit \u00e0 l'oubli\nasync def test_gdpr_user_deletion():\n    user = await create_test_user()\n    await user_service.delete_user_gdpr(user.id)\n\n    assert await db.users.find_one({\"_id\": user.id}) is None\n    orders = await db.orders.find({\"user_id\": user.id}).to_list(None)\n    assert all(o[\"user_id\"] == \"DELETED_USER\" for o in orders)\n\n# SOC2: Audit logs\nasync def test_soc2_access_logs():\n    await sensitive_service.view_data(user_id, doc_id)\n    log = await db.audit_logs.find_one({\"user_id\": user_id, \"action\": \"view_data\"})\n    assert log is not None and log[\"timestamp\"] is not None\n\n# PCI-DSS: Pas de carte stock\u00e9e\nasync def test_pci_no_card_storage():\n    payment = await payment_service.process({\"card_number\": \"4111111111111111\"})\n    db_payment = await db.payments.find_one({\"_id\": payment.id})\n    assert \"4111111111111111\" not in str(db_payment)\n```\n\n**Checklist Tests Avanc\u00e9s:**\n- [ ] Mutation: score >95%\n- [ ] Chaos: pod kill, network latency, DB failover\n- [ ] Contrat: consumer/provider v\u00e9rifi\u00e9s\n- [ ] Fuzz: endpoints publics fuzz\u00e9s 10k+ inputs\n- [ ] Conformit\u00e9: RGPD suppression, SOC2 audit logs, PCI pas de carte\n\n---\n\n## \ud83d\udee1\ufe0f R\u00c9SILIENCE\n\n```python\nfrom circuitbreaker import circuit\nfrom tenacity import retry, stop_after_attempt, wait_exponential\n\n@circuit(failure_threshold=5, recovery_timeout=60)\n@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=1, max=10))\nasync def call_api(endpoint: str) -> dict:\n    ...\n\n# Graceful degradation\nasync def get_recommendations(uid: int) -> List[Product]:\n    try:\n        return await ml_service.recommend(uid, timeout=2)\n    except (TimeoutError, MLError):\n        return await get_popular_products(limit=10)\n```\n\n---\n\n## \ud83d\udcca OBSERVABILIT\u00c9\n\n```python\n# Tracing\nfrom opentelemetry import trace\ntracer = trace.get_tracer(__name__)\n\nwith tracer.start_as_current_span(\"process_order\") as span:\n    span.set_attribute(\"order.id\", oid)\n\n# M\u00e9triques\nfrom prometheus_client import Counter, Histogram\norders_total = Counter('orders_total', 'Total orders', ['status'])\nrequest_duration = Histogram('request_duration_seconds', 'Latency', ['endpoint'])\n\n@request_duration.labels(endpoint='/orders').time():\n    order = create_order(data)\n    orders_total.labels(status='created').inc()\n\n# Health checks\n@app.get(\"/health\")\nasync def health():\n    checks = {\"db\": await check_db(), \"redis\": await check_redis()}\n    overall = all(c[\"status\"] == \"healthy\" for c in checks.values())\n    return JSONResponse(\n        status_code=200 if overall else 503,\n        content={\"status\": \"healthy\" if overall else \"unhealthy\", \"checks\": checks}\n    )\n```\n\n---\n\n## \ud83d\udeab INTERDICTIONS\n\n- \u274c \"Generated with Claude Code\" dans PR/commits\n- \u274c Code prod sans tests\n- \u274c Hardcoder secrets\n- \u274c SQL brut\n- \u274c eval(), exec(), pickle sur donn\u00e9es non fiables\n- \u274c Logger secrets\n- \u274c `except Exception:` sans re-raise\n- \u274c **BASH: utiliser `eval` au lieu de `bash -c`**\n- \u274c **BASH: \u00e9chapper manuellement `\\$`, `\\(`, `\\)`**\n- \u274c **BASH: commandes >3 lignes sans script temporaire**\n- \u274c **Modifier API sans mettre \u00e0 jour contracts/api.yaml d'abord**\n\n---\n\n## \ud83c\udf0d ENVIRONNEMENT\n\n**Syst\u00e8me:** WSL Ubuntu, User: tincenv, Workdir: /home/tincenv, GCP prioritaire\n\n**Secrets GCP:**\n```python\nfrom google.cloud import secretmanager\ndef get_secret(name: str) -> str:\n    client = secretmanager.SecretManagerServiceClient()\n    response = client.access_secret_version(\n        request={\"name\": f\"projects/{PROJECT_ID}/secrets/{name}/versions/latest\"}\n    )\n    return response.payload.data.decode(\"UTF-8\")\n```\n\n---\n\n## \ud83d\udc1a R\u00c8GLES BASH STRICTES\n\n### \u274c INTERDICTIONS\n\n```bash\n# \u274c JAMAIS eval\neval \"$COMMAND\"\n\n# \u274c JAMAIS \u00e9chapper manuellement\nPIPELINE_ID\\=\\$( cat file.json | jq .id )\n\n# \u274c JAMAIS echo pour ex\u00e9cuter\necho curl https://api.com\n```\n\n### \u2705 M\u00c9THODES CORRECTES\n\n**M\u00e9thode 1: Script temporaire (>3 lignes)**\n```bash\ncat > /tmp/script.sh <<'EOF'\n#!/bin/bash\nset -euo pipefail\nRESPONSE=$(curl -s https://api.com)\nID=$(echo \"$RESPONSE\" | jq -r .id)\necho \"ID: $ID\"\nEOF\nbash /tmp/script.sh\n```\n\n**M\u00e9thode 2: bash -c (<3 lignes)**\n```bash\nbash -c \"curl -s https://api.com | jq .id\"\n```\n\n**M\u00e9thode 3: Fonctions**\n```bash\ntrigger_pipeline() {\n  local project=\"$1\"\n  curl -s -XPOST \"https://gitlab.com/api/v4/projects/${project}/pipeline\" | jq -r .id\n}\nPIPELINE_ID=$(trigger_pipeline \"123\")\n```\n\n---\n\n## \ud83d\udce6 GIT & CI/CD\n\n**Branches:** feature/* \u2192 develop \u2192 main\n\n**GitLab CI:**\n```yaml\nstages: [quality, build, deploy]\nquality:\n  script:\n    - ruff check src/ tests/\n    - mypy src/ --strict\n    - pytest --cov --cov-fail-under=90\n    - mutmut run --paths-to-mutate=src/\nbuild:\n  script:\n    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .\ndeploy:\n  script:\n    - gcloud run deploy myapp --image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA\n  only: [main]\n```\n\n**Pre-commit:** trailing-whitespace, black, isort, ruff, mypy\n\n**Commits:** Conventional (feat/fix/docs/test/refactor/perf/chore)\n\n---\n\n## \ud83c\udfd7\ufe0f STRUCTURE PROJET\n\n```\nprojet/\n\u251c\u2500\u2500 contracts/              # SOURCE DE V\u00c9RIT\u00c9\n\u2502   \u251c\u2500\u2500 api.yaml           # OpenAPI spec\n\u2502   \u251c\u2500\u2500 types.ts           # Types partag\u00e9s frontend\n\u2502   \u2514\u2500\u2500 validators.py      # Validateurs Pydantic backend\n\u2502\n\u251c\u2500\u2500 backend/\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u2502   \u251c\u2500\u2500 core/          # Business logic (pure)\n\u2502   \u2502   \u251c\u2500\u2500 api/           # FastAPI routes (g\u00e9n\u00e9r\u00e9 depuis contracts/)\n\u2502   \u2502   \u2514\u2500\u2500 infrastructure/\n\u2502   \u251c\u2500\u2500 tests/\n\u2502   \u2502   \u251c\u2500\u2500 unit/\n\u2502   \u2502   \u251c\u2500\u2500 integration/\n\u2502   \u2502   \u251c\u2500\u2500 contract/      # Tests contrat provider\n\u2502   \u2502   \u251c\u2500\u2500 e2e/\n\u2502   \u2502   \u2514\u2500\u2500 chaos/\n\u2502   \u2514\u2500\u2500 .hooks/\n\u2502\n\u251c\u2500\u2500 frontend/\n\u2502   \u251c\u2500\u2500 src/\n\u2502   \u2502   \u251c\u2500\u2500 api/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 client.ts  # Client API (g\u00e9n\u00e9r\u00e9 depuis contracts/)\n\u2502   \u2502   \u251c\u2500\u2500 types/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 api.ts     # Types (g\u00e9n\u00e9r\u00e9s depuis contracts/)\n\u2502   \u2502   \u2514\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 tests/\n\u2502   \u2502   \u251c\u2500\u2500 unit/\n\u2502   \u2502   \u2514\u2500\u2500 contract/      # Tests contrat consumer\n\u2502   \u2514\u2500\u2500 .hooks/\n\u2502\n\u251c\u2500\u2500 .claude/\n\u2502   \u251c\u2500\u2500 CLAUDE.md          # Ce fichier\n\u2502   \u251c\u2500\u2500 hooks/             # Hooks auto\n\u2502   \u251c\u2500\u2500 agents/            # Agents custom\n\u2502   \u2514\u2500\u2500 commands/          # Slash commands\n\u2502\n\u2514\u2500\u2500 scripts/\n    \u251c\u2500\u2500 generate-backend-from-contract.sh\n    \u251c\u2500\u2500 generate-frontend-from-contract.sh\n    \u2514\u2500\u2500 validate-contracts.sh\n```\n\n---\n\n## \ud83d\udccb CONFIG FILES\n\n**pytest.ini:**\n```ini\n[tool:pytest]\ntestpaths = tests\naddopts = -v --cov=src --cov-report=term-missing --cov-fail-under=90\n```\n\n**pyproject.toml:**\n```toml\n[tool.black]\nline-length = 100\n[tool.ruff]\nselect = [\"E\", \"W\", \"F\", \"I\", \"B\", \"C4\", \"S\"]  # S = security\n```\n\n---\n\n## \ud83d\ude80 AUTO-PARALL\u00c9LISATION\n\n**Claude d\u00e9tecte automatiquement et choisit:**\n- **Parallel (Bash):** Tests, linting, builds (3-5x plus rapide)\n- **Multi-agents:** Code review, security scan, performance audit (5-10x)\n\n**G\u00e9n\u00e9r\u00e9 automatiquement:**\n```bash\n# Parallel pour validation multi-niveaux\nif command -v parallel &> /dev/null; then\n  parallel --halt soon,fail=1 ::: \\\n    \"ruff check .\" \\\n    \"mypy . --strict\" \\\n    \"pytest tests/unit/\" \\\n    \"pytest tests/contract/\"\nelse\n  ruff check . & mypy . --strict & pytest tests/unit/ & pytest tests/contract/ & wait\nfi\n```\n\n---\n\n## \ud83d\udd04 PATTERN ASYNCHRONE - POLLING\n\n**Pour t\u00e2ches longues (>10s):**\n\n```bash\nTASK_ID=$(uuidgen | cut -d'-' -f1)\nDONE_FILE=\"/tmp/task_${TASK_ID}.done\"\n\n# Lancer background\n(\n  if bash -c \"$COMMAND\" > \"/tmp/task_${TASK_ID}.log\" 2>&1; then\n    echo \"0\" > \"$DONE_FILE\"\n  else\n    echo \"$?\" > \"$DONE_FILE\"\n  fi\n) &\n\n# Polling (10 checks max, 30s interval)\nfor attempt in $(seq 1 10); do\n  sleep 30\n  if [ -f \"$DONE_FILE\" ]; then\n    EXIT_CODE=$(cat \"$DONE_FILE\")\n    [ \"$EXIT_CODE\" = \"0\" ] && echo \"\u2705 Success\" || echo \"\u274c Failed\"\n    break\n  fi\n  echo \"\u23f3 Check $attempt/10...\"\ndone\n```\n\n**R\u00e8gles:**\n- \u274c JAMAIS `tail -f`, `wait`, boucle infinie\n- \u2705 TOUJOURS limite de checks (10 max)\n- \u2705 TOUJOURS timeout gracieux\n\n---\n\n## \u2705 CHECKLIST PR\u00c9-COMMIT\n\n**Code:** Type hints 100%, docstrings, DRY, fonctions <20 lignes\n\n**Tests:** TDD, coverage >=90%, unit+edge+cascade+contract, parametrized, property-based, mutation >95%\n\n**S\u00e9curit\u00e9:** Validation, sanitization, pas secrets, rate limiting, ORM, tests OWASP Top 10\n\n**Performance:** Pas N+1, indexes, caching, generators, async, pooling, P95<200ms\n\n**R\u00e9silience:** Circuit breakers, retry, timeouts, fallbacks, chaos tests\n\n**Observabilit\u00e9:** Logs JSON, tracing, m\u00e9triques, health checks\n\n**Docs:** README complet, architecture, docstrings, OpenAPI spec\n\n**Infra:** Dockerfile, docker-compose, .gitignore, .env.example\n\n**CI/CD:** GitLab CI, tests auto, linting, security scan, mutation testing\n\n**Contracts:** Backend/Frontend synchronis\u00e9s, tests contrat PASS\n\n**Score minimum:** 95% items coch\u00e9s pour merger (z\u00e9ro bug = exigence max)\n\n---\n\n## \ud83c\udfaf SLASH COMMANDS CUSTOM\n\n- `/check-all` - Validation compl\u00e8te 6 niveaux + rapport\n- `/sync-contracts` - Sync backend/frontend depuis contracts/api.yaml\n- `/security-audit` - Audit s\u00e9cu complet OWASP Top 10\n- `/performance-audit` - Audit perfs (N+1, memory, slow queries)\n- `/auto-heal` - D\u00e9tecte probl\u00e8mes + auto-fix + valide\n\n---\n\n## \ud83d\ude80 AUTO-REVIEW MENTAL\n\n**Avant pr\u00e9senter (checklist mentale rapide):**\n1. Exceptions non g\u00e9r\u00e9es? 2. Edge cases oubli\u00e9s? 3. Trop responsabilit\u00e9s?\n4. Code mort? 5. Noms explicites? 6. Boucles O(n\u00b2)?\n7. Devrait \u00eatre async? 8. DB dans boucle (N+1)? 9. Entr\u00e9es valid\u00e9es?\n10. Risque injection? 11. Secrets expos\u00e9s? 12. Permissions v\u00e9rifi\u00e9es?\n13. **Contrat API mis \u00e0 jour?** 14. **Tests contrat PASS?**\n\n**Si 1 probl\u00e8me \u2192 REFACTOR avant pr\u00e9senter**\n\n---\n\n## \ud83c\udfc6 PHILOSOPHIE\n\n**Code doit \u00eatre (ordre priorit\u00e9):**\n1. **Correctness** (test\u00e9 \u00e0 90%+, mutation >95%)\n2. **Security** (0 vuln\u00e9rabilit\u00e9, validation compl\u00e8te)\n3. **Maintainability** (propre, document\u00e9, contracts/)\n4. **Performance** (optimis\u00e9, P95<200ms, 0 N+1)\n\n**R\u00c8GLE D'OR:** Code prod sans tests pr\u00e9alables = INVALIDE \u2192 SUPPRIMER et RECOMMENCER\n\n**R\u00c8GLE #2:** Modification API sans contracts/api.yaml = INVALIDE \u2192 RECOMMENCER\n\n**AUCUNE EXCEPTION. JAMAIS.**\n\n\n      IMPORTANT: this context may or may not be relevant to your tasks. You should not respond to this context unless it is highly relevant to your task.\n</system-reminder>\n"
              },
              {
                "type": "text",
                "text": "Warmup",
                "cache_control": {
                  "type": "ephemeral"
                }
              }
            ]
          }
        ],
        "system": [
          {
            "type": "text",
            "text": "You are Claude Code, Anthropic's official CLI for Claude.",
            "cache_control": {
              "type": "ephemeral"
            }
          },
          {
            "type": "text",
            "text": "You are a file search specialist for Claude Code, Anthropic's official CLI for Claude. You excel at thoroughly navigating and exploring codebases.\n\nYour strengths:\n- Rapidly finding files using glob patterns\n- Searching code and text with powerful regex patterns\n- Reading and analyzing file contents\n\nGuidelines:\n- Use Glob for broad file pattern matching\n- Use Grep for searching file contents with regex\n- Use Read when you know the specific file path you need to read\n- Use Bash for file operations like copying, moving, or listing directory contents\n- Adapt your search approach based on the thoroughness level specified by the caller\n- Return file paths as absolute paths in your final response\n- For clear communication, avoid using emojis\n- Do not create any files, or run bash commands that modify the user's system state in any way\n\nComplete the user's search request efficiently and report your findings clearly.\n\n\nNotes:\n- Agent threads always have their cwd reset between bash calls, as a result please only use absolute file paths.\n- In your final response always share relevant file names and code snippets. Any file paths you return in your response MUST be absolute. Do NOT use relative paths.\n- For clear communication with the user the assistant MUST avoid using emojis.\n\nHere is useful information about the environment you are running in:\n<env>\nWorking directory: /mnt/c/Users/tince\nIs directory a git repo: No\nPlatform: linux\nOS Version: Linux 6.6.87.2-microsoft-standard-WSL2\nToday's date: 2025-11-05\n</env>\nYou are powered by the model named Sonnet 4.5. The exact model ID is claude-sonnet-4-5-20250929.\n\nAssistant knowledge cutoff is January 2025.\n\n<claude_background_info>\nThe most recent frontier Claude model is Claude Sonnet 4.5 (model ID: 'claude-sonnet-4-5-20250929').\n</claude_background_info>\n",
            "cache_control": {
              "type": "ephemeral"
            }
          }
        ],
        "tools": [],
        "metadata": {
          "user_id": "user_30a57580f2507a87ed4e34d6621742e8b928423cabd2076ea8ca520cc9c3b008_account_1ba668a2-22ea-4bb1-b844-28efc13e2298_session_d88a9d81-e791-4eec-adc9-fca0dfbaa024"
        },
        "max_tokens": 32000,
        "thinking": {
          "budget_tokens": 30000,
          "type": "enabled"
        },
        "stream": true
      }
    },
    "response": {
      "status": 200,
      "headers": {
        "Date": "Wed, 05 Nov 2025 09:25:59 GMT",
        "Content-Type": "text/event-stream; charset=utf-8",
        "Transfer-Encoding": "chunked",
        "Connection": "close",
        "CF-RAY": "999b4e881f71e1d4-MRS",
        "Cache-Control": "no-cache",
        "anthropic-ratelimit-unified-status": "allowed",
        "anthropic-ratelimit-unified-5h-status": "allowed",
        "anthropic-ratelimit-unified-5h-reset": "1762344000",
        "anthropic-ratelimit-unified-7d-status": "allowed",
        "anthropic-ratelimit-unified-7d-reset": "1762761600",
        "anthropic-ratelimit-unified-representative-claim": "five_hour",
        "anthropic-ratelimit-unified-fallback-percentage": "0.5",
        "anthropic-ratelimit-unified-reset": "1762344000",
        "anthropic-ratelimit-unified-overage-disabled-reason": "out_of_credits",
        "request-id": "req_011CUpW7614DnrcRMgN3Bp3u",
        "strict-transport-security": "max-age=31536000; includeSubDomains; preload",
        "anthropic-organization-id": "dfc8fb78-2af7-446f-9683-dac08fd0d804",
        "x-envoy-upstream-service-time": "2321",
        "cf-cache-status": "DYNAMIC",
        "X-Robots-Tag": "none",
        "Server": "cloudflare"
      },
      "body": "event: message_start\ndata: {\"type\":\"message_start\",\"message\":{\"model\":\"claude-sonnet-4-5-20250929\",\"id\":\"msg_01M4qg6Tcxkjz1541wQGA9NQ\",\"type\":\"message\",\"role\":\"assistant\",\"content\":[],\"stop_reason\":null,\"stop_sequence\":null,\"usage\":{\"input_tokens\":8,\"cache_creation_input_tokens\":9293,\"cache_read_input_tokens\":0,\"cache_creation\":{\"ephemeral_5m_input_tokens\":9293,\"ephemeral_1h_input_tokens\":0},\"output_tokens\":2,\"service_tier\":\"standard\"}}               }\n\nevent: content_block_start\ndata: {\"type\":\"..."
    }
  }
]